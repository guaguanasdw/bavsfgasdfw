name: VS Code (Cloudflare Tunnel)

on:
  workflow_dispatch:

jobs:
  setup-vscode:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Random Password and Output to Log
        id: generate_pass
        run: |
          # 1. ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
          PASSWORD=$(openssl rand -base64 24)
          
          # 2. ã€é‡è¦ã€‘å…ˆã«ãƒ­ã‚°ã«å‡ºåŠ›ã™ã‚‹ï¼ˆãƒžã‚¹ã‚¯ã‚ˆã‚Šå…ˆã«æ›¸ãã¨è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
          echo "=========================================="
          echo "Generated Password: $PASSWORD"
          echo "=========================================="
          
          # 3. GitHubã®ãƒžã‚¹ã‚¯æ©Ÿèƒ½ã«ç™»éŒ²ï¼ˆã“ã‚Œä»¥é™ã€ãƒ­ã‚°ä¸Šã¯***ã¨è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
          echo "::add-mask::$PASSWORD"
          
          # 4. å‡ºåŠ›å¤‰æ•°ã«ã‚»ãƒƒãƒˆ
          echo "password=$PASSWORD" >> $GITHUB_OUTPUT

      - name: Install VS Code (code-server)
        run: |
          docker run -d \
            --name code-server \
            -p 127.0.0.1:8080:8080 \
            -v "${PWD}:/home/coder/project" \
            -e PASSWORD="${{ steps.generate_pass.outputs.password }}" \
            codercom/code-server:latest

      - name: Install Cloudflared
        run: |
          curl -L --output cloudflared https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          chmod +x cloudflared

      - name: Start Cloudflare Tunnel
        id: tunnel
        run: |
          echo "Starting Cloudflare Tunnel..."
          
          # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œ
          ./cloudflared tunnel --url http://127.0.0.1:8080 --loglevel info > /tmp/tunnel.log 2>&1 &
          
          # URLãŒå‡ºåŠ›ã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿï¼ˆæœ€å¤§30ç§’ï¼‰
          for i in {1..30}; do
            if grep -q "https://" /tmp/tunnel.log; then
              break
            fi
            sleep 1
          done
          
          # ãƒ­ã‚°ã‹ã‚‰URLã‚’æŠ½å‡º
          URL=$(grep -m 1 "https://" /tmp/tunnel.log | awk '{print $NF}')
          
          # URLã‚’ãƒ­ã‚°ã«è¡¨ç¤º
          echo "=========================================="
          echo "Access URL: $URL"
          echo "=========================================="
          
          # å‡ºåŠ›å¤‰æ•°ã«ã‚»ãƒƒãƒˆ
          echo "access_url=$URL" >> $GITHUB_OUTPUT

      - name: Summary Info
        if: steps.tunnel.outputs.access_url != ''
        run: |
          echo "### ðŸš€ Access Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.tunnel.outputs.access_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Password:** ${{ steps.generate_pass.outputs.password }}" >> $GITHUB_STEP_SUMMARY

      - name: Keep Alive
        run: |
          echo "Workflow is running. Click 'Cancel workflow' to stop."
          sleep 360m
