name: Expose Windows via Cloudflare Tunnel

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  expose:
    runs-on: windows-latest
    steps:

      - name: Checkout
        uses: actions/checkout@v4

      # Cloudflared をセットアップ（Windows 対応）
      - name: Setup cloudflared
        uses: AnimMouse/setup-cloudflared@v2

      # トンネル情報を展開する
      - name: Write Tunnel Credentials
        run: |
          mkdir $env:USERPROFILE\.cloudflared
          echo $env:CLOUDFLARE_TUNNEL_CREDENTIAL_BASE64 | Out-File cred.b64
          certutil -decode cred.b64 "$env:USERPROFILE\.cloudflared\tunnel.json"
          echo $env:CLOUDFLARE_TUNNEL_CONFIGURATION_BASE64 | Out-File cfg.b64
          certutil -decode cfg.b64 "$env:USERPROFILE\.cloudflared\config.yml"
        
        env:
          CLOUDFLARE_TUNNEL_CREDENTIAL_BASE64: ${{ secrets.CLOUDFLARE_TUNNEL_CREDENTIAL }}
          CLOUDFLARE_TUNNEL_CONFIGURATION_BASE64: ${{ secrets.CLOUDFLARE_TUNNEL_CONFIGURATION }}

      - name: Show cloudflared version
        run: cloudflared -v

      # Cloudflare Tunnel 起動（トンネルIDを明示的に渡す）
      - name: Start Cloudflare Tunnel
        run: |
          # トンネルIDを直接渡す
          cloudflared tunnel --config "$env:USERPROFILE\.cloudflared\config.yml" run ${{ secrets.CLOUDFLARE_TUNNEL_ID }}

      # 任意のサービス起動例
      - name: Start Example App
        run: |
          Start-Process -NoNewWindow -FilePath "powershell" -ArgumentList "-command", "while($true){ Write-Host Listening...; Start-Sleep -Seconds 10 }"
     
      - name: Output generated password
        run: |
          $pw=[System.Web.Security.Membership]::GeneratePassword(20,4)
          Write-Host "Generated password: $pw"
