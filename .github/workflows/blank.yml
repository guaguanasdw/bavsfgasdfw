name: Windows Browser Desktop via Cloudflare Tunnel (Fixed)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  desktop:
    runs-on: windows-latest
    timeout-minutes: 60

    env:
      VNC_PORT: 5900
      NOVNC_PORT: 6080

    steps:
      - name: チェックアウト
        uses: actions/checkout@v4

      # Chocolatey で UltraVNC をインストール
      # サイレントインストールのみで、サービス登録はされない【turn3fetch0】
      - name: UltraVNC をインストール
        run: choco install ultravnc -y

      # パスワード設定のために createpassword ツールをダウンロード
      # 公式: createpassword [-secure] mypassword （ultravnc.ini フォルダで実行）【turn6search6】
      - name: createpassword ツールを取得・展開
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $zipUrl = 'https://uvnc.eu/download/133/createpassword.zip'
          $zipPath = "$env:TEMP\createpassword.zip"
          $destDir   = "${env:ProgramFiles}\UltraVNC"

          Invoke-WebRequest -Uri $zipUrl -OutFile $zipPath -UseBasicParsing
          Expand-Archive -Path $zipPath -DestinationPath $destDir -Force

          Write-Host "createpassword expanded to $destDir"

      # UltraVNC をアプリモードで起動＋パスワード設定
      # パスワードは createpassword で ultravnc.ini に書き込む【turn6search6】
      - name: UltraVNC (winvnc.exe) をアプリモードで起動＆パスワード設定＆ログ出力
        shell: pwsh
        env:
          VNC_PASSWORD: ${{ secrets.VNC_PASSWORD }}
        run: |
          $ErrorActionPreference = 'Stop'

          if (-not $env:VNC_PASSWORD) {
            Write-Host "::error::VNC_PASSWORD secret is not set."
            exit 1
          }

          $uvncDir = "${env:ProgramFiles}\UltraVNC"
          $createpassword = "$uvncDir\createpassword.exe"
          $winvnc = "$uvncDir\winvnc.exe"
          $iniFile = "$uvncDir\ultravnc.ini"

          # 必要に応じて ultravnc.ini を空作成（createpassword が上書きするため）
          if (-not (Test-Path $iniFile)) {
            New-Item -Path $iniFile -ItemType File -Force | Out-Null
          }

          # 公式に従い、ultravnc.ini のあるフォルダで createpassword を実行【turn6search6】
          Push-Location $uvncDir
          try {
            & $createpassword $env:VNC_PASSWORD
            if ($LASTEXITCODE -ne 0) {
              Write-Host "::warning::createpassword exited with code $LASTEXITCODE"
            }
          }
          finally {
            Pop-Location
          }

          # ultravnc.ini が生成されたことをログ出力（確認用）
          Get-Content $iniFile | Out-String | Write-Host

          # winvnc.exe をアプリモードで起動（-run）【turn5search3】
          $proc = Start-Process -FilePath $winvnc -ArgumentList '-run' -PassThru
          $id = $proc.Id
          echo "WINVNC_PID=$id" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8

          # 要件通り、パスワードをログに出力
          Write-Host "=========================================="
          Write-Host "VNC Password: ${env:VNC_PASSWORD}"
          Write-Host "=========================================="
          Write-Host "UltraVNC (winvnc.exe) started (PID=$id)."

      # noVNC ＋ websockify のセットアップ
      # noVNC は VNC → WebSocket をブリッジする websockify と一緒に使う【turn5search8】【turn0search10】
      - name: noVNC をセットアップ
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $workDir = "$env:GITHUB_WORKSPACE\novnc"
          New-Item -ItemType Directory -Force -Path $workDir | Out-Null

          $zipUrl = 'https://github.com/novnc/noVNC/archive/refs/heads/master.zip'
          $zipPath = "$env:TEMP\novnc.zip"
          Invoke-WebRequest -Uri $zipUrl -OutFile $zipPath -UseBasicParsing
          Expand-Archive -Path $zipPath -DestinationPath $workDir -Force

          $env:NOVNC_HOME = "$workDir\noVNC-master"
          echo "NOVNC_HOME=$env:NOVNC_HOME" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8

          # websockify をインストール【turn0search10】
          python -m pip install --upgrade pip
          pip install websockify

      # websockify 経由で noVNC を localhost:6080 に公開
      - name: noVNC (websockify) を起動
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $port = $env:NOVNC_PORT
          $vncTarget = "127.0.0.1:$env:VNC_PORT"
          $webDir = $env:NOVNC_HOME

          # バックグラウンドで websockify 起動
          $job = Start-Process -FilePath 'websockify' -ArgumentList @(
            "$port",
            "$vncTarget",
            "--web=$webDir"
          ) -PassThru -NoNewWindow

          $id = $job.Id
          echo "WEBSOCKIFY_PID=$id" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8

          Write-Host "websockify started on http://127.0.0.1:$port (PID=$id)"

      # Cloudflare Tunnel (TryCloudflare) をセットアップ
      # setup-cloudflared アクションで cloudflared をインストール【turn0search11】【turn0search15】
      - name: Cloudflare Tunnel (setup-cloudflared) をセットアップ
        uses: AnimMouse/setup-cloudflared@v2

      # noVNC のポート (6080) を Quick Tunnel で公開【turn0search16】【turn0search14】
      - name: Cloudflare Quick Tunnel で noVNC をインターネットに公開
        uses: AnimMouse/setup-cloudflared/tunnel@v2
        with:
          url: http://127.0.0.1:6080

      # 操作用の時間を稼ぐため待機
      - name: デスクトップ操作用に待機
        shell: pwsh
        run: |
          $waitMinutes = 55
          Write-Host "Sleeping for $waitMinutes minutes so you can use the desktop..."
          $seconds = $waitMinutes * 60
          Start-Sleep -Seconds $seconds
