name: Windows Web RDP (Fixed)

on:
  workflow_dispatch: # 手動実行のみ

jobs:
  web_rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    # WindowsホストでRDP有効化
    - name: Setup Host RDP
      run: |
        # パスワード設定
        $password = "P@ssw0rd123"
        Write-Host "================================================"
        Write-Host "WINDOWS PASSWORD: $password"
        Write-Host "================================================"
        
        net user runneradmin $password
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389

    # DockerをLinuxコンテナモードに切り替え（パス自動検出機能付き）
    - name: Switch Docker to Linux
      run: |
        Write-Host "Searching for DockerCli.exe..."
        # 標準的なパスを試す
        $dockerCli = "C:\Program Files\Docker\Docker\DockerCli.exe"
        
        # なければ再帰的に探す
        if (-not (Test-Path $dockerCli)) {
            $dockerCli = (Get-ChildItem "C:\Program Files\Docker" -Recurse -Filter DockerCli.exe -ErrorAction SilentlyContinue | Select-Object -First 1).FullName
        }

        if ($dockerCli -and (Test-Path $dockerCli)) {
            Write-Host "Found Docker CLI at: $dockerCli"
            # Linuxエンジンに切り替え
            & $dockerCli -SwitchLinuxEngine
            Write-Host "Docker switched to Linux Engine."
            
            # 切り替え完了を待機
            Start-Sleep -Seconds 10
        } else {
            Write-Host "Warning: DockerCli.exe not found. Assuming default config..."
        }

    # Guacamoleの起動（環境変数で自動設定）
    - name: Start Guacamole with Auto-Login
      run: |
        # イメージのプル（初回のみ）
        docker pull oznu/guacamole
        
        # パスワード再取得
        $password = "P@ssw0rd123"
        
        # コンテナ起動
        # 環境変数を使うことで、ブラウザ開くだけでRDP接続されるように設定
        docker run -d `
          --name guacamole `
          -p 8080:8080 `
          -e RDP_HOST=host.docker.internal `
          -e RDP_PORT=3389 `
          -e RDP_USER=runneradmin `
          -e RDP_PASSWORD=$password `
          -e GUACAMOLE_HOME=/guacamole-home `
          oznu/guacamole

    # Cloudflaredのダウンロードと実行
    - name: Start Cloudflare Tunnel
      run: |
        Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe"
        
        Write-Host "================================================"
        Write-Host "Starting Cloudflare Tunnel..."
        Write-Host "Access the URL below in your browser:"
        Write-Host "It will log you in automatically."
        Write-Host "================================================"
        
        # Guacamoleのポート8080を公開
        .\cloudflared.exe tunnel --url http://localhost:8080

    # 終了防止
    - name: Keep Alive
      if: false
      run: while ($true) { Start-Sleep -Seconds 3600 }
