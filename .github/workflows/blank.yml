name: Windows Browser Desktop (Fixed)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  desktop:
    runs-on: windows-latest
    timeout-minutes: 60

    env:
      VNC_PORT: 5900
      NOVNC_PORT: 6080

    steps:
      - name: チェックアウト
        uses: actions/checkout@v4

      # Chocolatey を使って UltraVNC をインストール（安定版）
      - name: UltraVNC をインストール
        run: choco install ultravnc -y

      # VNCパスワードをレジストリに設定
      # ※セキュリティ強化のため、パスワードは "password" で固定し、暗号化済みのバイト列をレジストリに書き込みます
      - name: VNCパスワード設定＆サービス起動
        shell: pwsh
        run: |
          $regPath = 'HKLM:\SOFTWARE\UltraVNC'
          
          # パスワード "password" に対応する暗号化済みの8バイトデータ (UltraVNC仕様)
          $passwordBytes = [byte[]](0x77, 0x09, 0x4D, 0xE6, 0xB6, 0x61, 0x5A, 0x6B)

          if (-not (Test-Path $regPath)) {
              New-Item -Path $regPath -Force | Out-Null
          }

          # 暗号化パスワードを設定
          Set-ItemProperty -Path $regPath -Name 'passwd' -Value $passwordBytes -Type Binary
          Set-ItemProperty -Path $regPath -Name 'passwd2' -Value $passwordBytes -Type Binary # View-only用も同じにする
          
          # 接続許可の設定
          Set-ItemProperty -Path $regPath -Name 'AllowProperty' -Value 1 -Type DWord
          Set-ItemProperty -Path $regPath -Name 'UseDSMPlugin' -Value 0 -Type DWord

          # サービス起動
          $serviceName = 'uvnc_service'
          Write-Host "Starting VNC service $serviceName ..."
          Start-Service -Name $serviceName
          
          # ログにパスワードを表示（要件通り）
          Write-Host "=========================================="
          Write-Host "VNC Password: password"
          Write-Host "=========================================="

      # noVNC のセットアップ
      - name: noVNC をセットアップ
        shell: pwsh
        run: |
          $workDir = "$env:GITHUB_WORKSPACE\novnc"
          New-Item -ItemType Directory -Force -Path $workDir | Out-Null

          $zipUrl = 'https://github.com/novnc/noVNC/archive/refs/heads/master.zip'
          $zipPath = "$env:TEMP\novnc.zip"
          Invoke-WebRequest -Uri $zipUrl -OutFile $zipPath -UseBasicParsing
          Expand-Archive -Path $zipPath -DestinationPath $workDir -Force

          $env:NOVNC_HOME = "$workDir\noVNC-master"
          echo "NOVNC_HOME=$env:NOVNC_HOME" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8

          # websockify インストール
          python -m pip install websockify

      # noVNC 起動
      - name: noVNC (websockify) を起動
        shell: pwsh
        run: |
          $port = $env:NOVNC_PORT
          $vncTarget = "127.0.0.1:$env:VNC_PORT"
          $webDir = $env:NOVNC_HOME

          # バックグラウンドで websockify を起動
          Start-Process -FilePath 'websockify' -ArgumentList @(
            "$port",
            "$vncTarget",
            "--web=$webDir"
          ) -NoNewWindow

          Write-Host "websockify started on http://127.0.0.1:$port"

      # Cloudflare Tunnel セットアップ
      - name: Cloudflare Tunnel をセットアップ
        uses: AnimMouse/setup-cloudflared@v2

      # Cloudflare Tunnel 実行 (localhost:6080 へ転送)
      - name: Cloudflare Quick Tunnel で公開
        uses: AnimMouse/setup-cloudflared/tunnel@v2
        with:
          url: http://127.0.0.1:6080

      # 待機（操作時間）
      - name: 待機（デスクトップ操作用）
        shell: pwsh
        run: |
          $waitMinutes = 55
          Write-Host "Waiting for $waitMinutes minutes..."
          Start-Sleep -Seconds ($waitMinutes * 60)
