name: Expose Windows via Cloudflare Tunnel

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  expose:
    runs-on: windows-latest
    steps:

      - name: Checkout
        uses: actions/checkout@v4

      # Cloudflared をセットアップ（Windows 対応）
      - name: Setup cloudflared
        uses: AnimMouse/setup-cloudflared@v2

      # config.yml を手動で作成
      - name: Create config.yml
        run: |
          $configPath = "$env:USERPROFILE\.cloudflared\config.yml"
          mkdir $env:USERPROFILE\.cloudflared
          Set-Content -Path $configPath -Value @"
tunnel: ${{ secrets.CLOUDFLARE_TUNNEL_ID }}
credentials-file: C:\Users\runneradmin\.cloudflared\tunnel.json
ingress:
  - hostname: yourdomain.example.com
    service: http://localhost:8080
  - service: http_status:404
"@
        
      # config.yml の中身をデバッグ表示
      - name: Show config.yml contents
        run: |
          Get-Content "$env:USERPROFILE\.cloudflared\config.yml"
        
      - name: Show cloudflared version
        run: cloudflared -v

      # Cloudflare Tunnel 起動（トンネルIDを直接渡す）
      - name: Start Cloudflare Tunnel
        run: |
          cloudflared tunnel --config "$env:USERPROFILE\.cloudflared\config.yml" run ${{ secrets.CLOUDFLARE_TUNNEL_ID }}

      # 任意のサービス起動例
      - name: Start Example App
        run: |
          Start-Process -NoNewWindow -FilePath "powershell" -ArgumentList "-command", "while($true){ Write-Host Listening...; Start-Sleep -Seconds 10 }"
     
      - name: Output generated password
        run: |
          $pw=[System.Web.Security.Membership]::GeneratePassword(20,4)
          Write-Host "Generated password: $pw"
