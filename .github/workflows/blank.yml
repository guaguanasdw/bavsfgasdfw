name: Windows Browser Desktop (Fixed Quotes & Long Life)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  desktop:
    runs-on: windows-latest
    # æœ€å¤§6æ™‚é–“ã¾ã§ç¶­æŒ
    timeout-minutes: 360

    env:
      VNC_PORT: 5900
      NOVNC_PORT: 6080

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: UltraVNC ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: choco install ultravnc -y

      # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã®ãŸã‚ã« createpassword ãƒ„ãƒ¼ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      - name: createpassword ãƒ„ãƒ¼ãƒ«ã‚’å–å¾—ãƒ»å±•é–‹
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $zipUrl = 'https://uvnc.eu/download/133/createpassword.zip'
          $zipPath = "$env:TEMP\createpassword.zip"
          
          # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆã®ç‰¹å®š
          $uvncDir = "${env:ProgramFiles}\uvnc bvba\UltraVNC"
          if (-not (Test-Path $uvncDir)) {
              $uvncDir = "${env:ProgramFiles}\UltraVNC"
          }
          
          Invoke-WebRequest -Uri $zipUrl -OutFile $zipPath -UseBasicParsing
          Expand-Archive -Path $zipPath -DestinationPath $uvncDir -Force
          echo "UVNC_DIR=$uvncDir" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8

      # UltraVNC ã‚’ã‚¢ãƒ—ãƒªãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•
      - name: UltraVNC èµ·å‹•ï¼†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š
        shell: pwsh
        env:
          VNC_PASSWORD: ${{ secrets.VNC_PASSWORD }}
        run: |
          $ErrorActionPreference = 'Stop'

          # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæœªè¨­å®šãªã‚‰ "password" ã‚’ä½¿ç”¨
          $vncPass = if ($env:VNC_PASSWORD) { $env:VNC_PASSWORD } else { "password" }

          $uvncDir = $env:UVNC_DIR
          $createpassword = "$uvncDir\createpassword.exe"
          $winvnc = "$uvncDir\winvnc.exe"

          # ultravnc.ini ã®ã‚ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã§ createpassword ã‚’å®Ÿè¡Œ
          Push-Location $uvncDir
          try {
            & $createpassword $vncPass
          }
          finally {
            Pop-Location
          }

          # winvnc.exe ã‚’ã‚¢ãƒ—ãƒªãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ï¼ˆ-runï¼‰
          $proc = Start-Process -FilePath $winvnc -ArgumentList '-run' -PassThru
          echo "WINVNC_PID=$($proc.Id)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8
          Write-Host "UltraVNC started. Password: $vncPass"

      # noVNC ï¼‹ websockify ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: noVNC ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $workDir = "$env:GITHUB_WORKSPACE\novnc"
          New-Item -ItemType Directory -Force -Path $workDir | Out-Null
          $zipUrl = 'https://github.com/novnc/noVNC/archive/refs/heads/master.zip'
          $zipPath = "$env:TEMP\novnc.zip"
          Invoke-WebRequest -Uri $zipUrl -OutFile $zipPath -UseBasicParsing
          Expand-Archive -Path $zipPath -DestinationPath $workDir -Force
          echo "NOVNC_HOME=$workDir\noVNC-master" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8
          python -m pip install websockify

      # websockify èµ·å‹•
      - name: noVNC (websockify) ã‚’èµ·å‹•
        shell: pwsh
        run: |
          $port = $env:NOVNC_PORT
          $vncTarget = "127.0.0.1:$env:VNC_PORT"
          $webDir = $env:NOVNC_HOME
          Start-Process -FilePath 'websockify' -ArgumentList @("$port", "$vncTarget", "--web=$webDir") -NoNewWindow
          Write-Host "websockify started on http://127.0.0.1:$port"

      # Cloudflare Tunnel ãƒã‚¤ãƒŠãƒªã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Cloudflare Tunnel ãƒã‚¤ãƒŠãƒªã‚’æº–å‚™
        uses: AnimMouse/setup-cloudflared@v2

      # Cloudflare Tunnel æ‰‹å‹•èµ·å‹• & URLæŠ½å‡ºï¼†å·¨å¤§è¡¨ç¤º
      # â€»æ–‡å­—åˆ—ã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚ã€å˜ä¸€å¼•ç”¨ç¬¦ ' ã‚’ä½¿ç”¨ã—ã€å¤‰æ•°ã¯ -f ã§åŸ‹ã‚è¾¼ã‚€å½¢å¼ã«å¤‰æ›´
      - name: Cloudflare Tunnel èµ·å‹• & URLã‚’è¡¨ç¤º
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          
          # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ cloudflared ã‚’èµ·å‹•ã—ã€ãƒ­ã‚°ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«åã‹ã›ã‚‹
          $logFile = "$env:TEMP\cf-tunnel.log"
          Start-Process -FilePath 'cloudflared' -ArgumentList 'tunnel --url http://127.0.0.1:6080' -RedirectStandardOutput $logFile -RedirectStandardError $logFile -NoNewWindow

          # URLãŒå‡ºåŠ›ã•ã‚Œã‚‹ã¾ã§æœ€å¤§15ç§’å¾…æ©Ÿ
          Write-Host 'Waiting for Cloudflare Tunnel URL...'
          $maxWait = 15
          $url = $null
          for ($i = 0; $i -lt $maxWait; $i++) {
              Start-Sleep -Seconds 1
              $content = Get-Content $logFile -Raw -ErrorAction SilentlyContinue
              if ($content -match 'https://[a-zA-Z0-9\-\.]+trycloudflare\.com') {
                  $url = $matches[0]
                  break
              }
          }

          if ($url) {
              # è¦‹ã‚„ã™ã„ã‚ˆã†ã«å·¨å¤§ã«è¡¨ç¤ºï¼ˆå¼•ç”¨ç¬¦ã‚¨ãƒ©ãƒ¼å›é¿ã®ãŸã‚å˜ä¸€å¼•ç”¨ç¬¦ã¨-fæ¼”ç®—å­ã‚’ä½¿ç”¨ï¼‰
              Write-Host ''
              Write-Host '###########################################################################' -ForegroundColor Green
              Write-Host '#                                                                         #' -ForegroundColor Green
              Write-Host '#   â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…   ' -ForegroundColor Green
              Write-Host '#                                                                         #' -ForegroundColor Green
              Write-Host '#   Windows ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã¸ã®æ¥ç¶šæƒ…å ±                                       #' -ForegroundColor Green
              Write-Host '#                                                                         #' -ForegroundColor Green
              Write-Host ('#   æ¥ç¶šURL (URL) : {0}                                                       #' -f $url) -ForegroundColor Green
              Write-Host '#                                                                         #' -ForegroundColor Green
              Write-Host '#   ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (Password) :                                                 #' -ForegroundColor Green
              Write-Host '#   password                                                                #' -ForegroundColor Green
              Write-Host '#                                                                         #' -ForegroundColor Green
              Write-Host '#   â€» ä¸Šè¨˜ã®URLã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãƒ–ãƒ©ã‚¦ã‚¶ã§æ“ä½œã§ãã¾ã™                      #' -ForegroundColor Green
              Write-Host '#                                                                         #' -ForegroundColor Green
              Write-Host '###########################################################################' -ForegroundColor Green
              Write-Host ''
              
              # Job Summaryã«ã‚‚è¡¨ç¤º
              echo '### ğŸ–¥ï¸ Windows Remote Desktop' >> $env:GITHUB_STEP_SUMMARY
              echo ('**URL:** {0}' -f $url) >> $env:GITHUB_STEP_SUMMARY
              echo '**Password:** `password`' >> $env:GITHUB_STEP_SUMMARY
          } else {
              # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚å˜ä¸€å¼•ç”¨ç¬¦ã§å›²ã‚€
              Write-Host '::error::Cloudflare Tunnel URLã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
              Get-Content $logFile | Write-Host
          }

      # é•·æ™‚é–“ç¶­æŒã®ãŸã‚ã®å¾…æ©Ÿãƒ«ãƒ¼ãƒ—
      - name: ç’°å¢ƒç¶­æŒï¼ˆæœ€å¤§6æ™‚é–“ã¾ã§å¾…æ©Ÿï¼‰
        shell: pwsh
        run: |
          $totalMinutes = 350
          $checkInterval = 10 
          
          Write-Host '============================================================'
          Write-Host ('  ç’°å¢ƒã‚’ {0} åˆ†é–“ï¼ˆç´„6æ™‚é–“ï¼‰ç¶­æŒã—ã¾ã™...' -f $totalMinutes)
          Write-Host '  ä¸Šè¨˜ã®URLã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚'
          Write-Host '============================================================'

          $elapsed = 0
          while ($elapsed -lt $totalMinutes) {
              Start-Sleep -Seconds ($checkInterval * 60)
              $elapsed += $checkInterval
              $remaining = $totalMinutes - $elapsed
              Write-Host ('[{0}] ç’°å¢ƒç¶­æŒä¸­... æ®‹ã‚Šç´„ {1} åˆ†' -f (Get-Date -Format 'HH:mm:ss'), $remaining)
          }
