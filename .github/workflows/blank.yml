name: Expose Windows to Browser

on:
  push:
    branches:
      - main

jobs:
  expose-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Cloudflare Tunnel
      run: |
        # Cloudflare Tunnelのインストール
        Invoke-WebRequest -Uri https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe
        Rename-Item cloudflared.exe cloudflared
        # cloudflaredを実行するために必要な環境変数
        $Env:CLOUDFLARE_TUNNEL_SECRET = $env:CLOUDFLARE_TUNNEL_SECRET
        ./cloudflared.exe --version

    - name: Start VNC Server
      run: |
        # VNCサーバーをインストールして起動
        choco install tightvnc
        Start-Process -NoNewWindow -FilePath "C:\Program Files\TightVNC\tvnserver.exe" -ArgumentList "-run"

    - name: Expose via Cloudflare Tunnel
      run: |
        # Cloudflare Tunnelの設定を開始
        echo "Starting Cloudflare Tunnel"
        cloudflared tunnel --url vnc://localhost:5900 &
        # クラウドフレアトンネルをブラウザ上でアクセスできるようにする
        sleep 10  # Tunnelが安定するまで待機

    - name: Output Tunnel URL and VNC Password
      run: |
        # ここでパスワードを表示する
        $vncPassword = "your-secure-password"
        Write-Host "VNC Server is running on : vnc://localhost:5900"
        Write-Host "Cloudflare Tunnel URL: https://your-cloudflare-tunnel-url"
        Write-Host "VNC Password: $vncPassword"

    - name: Expose noVNC Web Interface
      run: |
        # noVNCをセットアップしてブラウザからVNCにアクセス可能にする
        choco install novnc
        cd "C:\Program Files\novnc"
        Start-Process -NoNewWindow -FilePath "C:\Program Files\novnc\start.bat" -ArgumentList "localhost:5900"
        
    - name: Keep the Action Alive
      run: |
        # 永続的にプロセスを維持
        while ($true) { Start-Sleep -Seconds 3600 }
