name: Windows Browser Desktop via Cloudflare Tunnel (Final Fixed)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  desktop:
    runs-on: windows-latest
    timeout-minutes: 60

    env:
      VNC_PORT: 5900
      NOVNC_PORT: 6080

    steps:
      - name: チェックアウト
        uses: actions/checkout@v4

      - name: UltraVNC をインストール
        run: choco install ultravnc -y

      # パスワード設定のために createpassword ツールをダウンロード
      - name: createpassword ツールを取得・展開
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $zipUrl = 'https://uvnc.eu/download/133/createpassword.zip'
          $zipPath = "$env:TEMP\createpassword.zip"
          
          # インストール先の特定 (uvnc bvba サブフォルダがあるか確認)
          $uvncDir = "${env:ProgramFiles}\uvnc bvba\UltraVNC"
          if (-not (Test-Path $uvncDir)) {
              $uvncDir = "${env:ProgramFiles}\UltraVNC"
          }
          
          Invoke-WebRequest -Uri $zipUrl -OutFile $zipPath -UseBasicParsing
          Expand-Archive -Path $zipPath -DestinationPath $uvncDir -Force
          echo "UVNC_DIR=$uvncDir" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8

      # UltraVNC をアプリモードで起動＋パスワード設定
      - name: UltraVNC (winvnc.exe) をアプリモードで起動＆パスワード設定＆ログ出力
        shell: pwsh
        env:
          VNC_PASSWORD: ${{ secrets.VNC_PASSWORD }}
        run: |
          $ErrorActionPreference = 'Stop'

          # パスワードが設定されていない場合はデフォルト値を使用
          $vncPass = if ($env:VNC_PASSWORD) { $env:VNC_PASSWORD } else { "password" }

          # 環境変数からインストールディレクトリを取得 (前のステップで設定したもの)
          $uvncDir = $env:UVNC_DIR
          $createpassword = "$uvncDir\createpassword.exe"
          $winvnc = "$uvncDir\winvnc.exe"
          $iniFile = "$uvncDir\ultravnc.ini"

          if (-not (Test-Path $createpassword)) {
              Write-Host "::error::createpassword.exe not found at $createpassword"
              exit 1
          }

          # ultravnc.ini のあるフォルダで createpassword を実行
          Push-Location $uvncDir
          try {
            & $createpassword $vncPass
          }
          finally {
            Pop-Location
          }

          # winvnc.exe をアプリモードで起動（-run）
          $proc = Start-Process -FilePath $winvnc -ArgumentList '-run' -PassThru
          echo "WINVNC_PID=$($proc.Id)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8

          # パスワードをログに出力
          Write-Host "=========================================="
          Write-Host "VNC Password: $vncPass"
          Write-Host "=========================================="
          Write-Host "UltraVNC started from $uvncDir"

      # noVNC ＋ websockify のセットアップ
      - name: noVNC をセットアップ
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $workDir = "$env:GITHUB_WORKSPACE\novnc"
          New-Item -ItemType Directory -Force -Path $workDir | Out-Null
          $zipUrl = 'https://github.com/novnc/noVNC/archive/refs/heads/master.zip'
          $zipPath = "$env:TEMP\novnc.zip"
          Invoke-WebRequest -Uri $zipUrl -OutFile $zipPath -UseBasicParsing
          Expand-Archive -Path $zipPath -DestinationPath $workDir -Force
          echo "NOVNC_HOME=$workDir\noVNC-master" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8
          python -m pip install websockify

      # websockify 起動
      - name: noVNC (websockify) を起動
        shell: pwsh
        run: |
          $port = $env:NOVNC_PORT
          $vncTarget = "127.0.0.1:$env:VNC_PORT"
          $webDir = $env:NOVNC_HOME
          Start-Process -FilePath 'websockify' -ArgumentList @("$port", "$vncTarget", "--web=$webDir") -NoNewWindow
          Write-Host "websockify started on http://127.0.0.1:$port"

      # Cloudflare Tunnel
      - name: Cloudflare Tunnel (setup-cloudflared) をセットアップ
        uses: AnimMouse/setup-cloudflared@v2

      - name: Cloudflare Quick Tunnel で公開
        uses: AnimMouse/setup-cloudflared/tunnel@v2
        with:
          url: http://127.0.0.1:6080

      # 待機
      - name: デスクトップ操作用に待機
        shell: pwsh
        run: |
          $waitMinutes = 55
          Write-Host "Waiting for $waitMinutes minutes..."
          Start-Sleep -Seconds ($waitMinutes * 60)
