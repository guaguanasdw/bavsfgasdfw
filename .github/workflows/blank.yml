name: VS Code (Cloudflare Tunnel - Log Output)

on:
  workflow_dispatch:

jobs:
  setup-vscode:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Random Password
        id: generate_pass
        run: |
          # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆãƒžã‚¹ã‚¯ã¯è¡Œã‚ãšã€ãã®ã¾ã¾ãƒ­ã‚°ã«å‡ºåŠ›ã™ã‚‹ï¼‰
          PASSWORD=$(openssl rand -base64 24)
          
          # ãƒ­ã‚°ã¸ç›´æŽ¥å‡ºåŠ›ï¼ˆè¦‹ã‚„ã™ãè£…é£¾ï¼‰
          echo ""
          echo "------------------------------------------------"
          echo "PASSWORD: $PASSWORD"
          echo "------------------------------------------------"
          echo ""
          
          # ç’°å¢ƒå¤‰æ•°ã¸ä¿å­˜
          echo "PASSWORD=$PASSWORD" >> $GITHUB_ENV

      - name: Install Cloudflared
        run: |
          curl -L --output cloudflared https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          chmod +x cloudflared

      - name: Start VS Code and Cloudflare Tunnel
        run: |
          # --- VS Code èµ·å‹• ---
          docker run -d \
            --name code-server \
            -p 127.0.0.1:8080:8080 \
            -v "${PWD}:/home/coder/project" \
            -e PASSWORD="${{ env.PASSWORD }}" \
            codercom/code-server:latest

          # --- Cloudflare Tunnel èµ·å‹• ---
          echo "Starting Cloudflare Tunnel..."
          ./cloudflared tunnel --url http://127.0.0.1:8080 --loglevel info > /tmp/tunnel.log 2>&1 &

          # --- URLæŠ½å‡ºãƒ«ãƒ¼ãƒ— ---
          # ãƒ­ã‚°ã®ä¸­ã‹ã‚‰ trycloudflare.com ãŒå«ã¾ã‚Œã‚‹è¡Œã‚’æ¤œç´¢ã—ã€æ­£ã—ã„URLã‚’æŠ½å‡ºã™ã‚‹
          echo "Waiting for Tunnel URL..."
          for i in {1..60}; do
            # æ­£è¦è¡¨ç¾ã§ https://...trycloudflare.com ã®ã¿ã‚’æŠ½å‡º
            URL=$(grep -oE "https://[^ ]+\.trycloudflare\.com" /tmp/tunnel.log | head -n 1)
            
            if [ -n "$URL" ]; then
              # URLãŒè¦‹ã¤ã‹ã£ãŸã‚‰å‡ºåŠ›ã—ã¦ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
              echo ""
              echo "------------------------------------------------"
              echo "ACCESS URL: $URL"
              echo "------------------------------------------------"
              echo ""
              echo "Copy the URL and Password above to access VS Code."
              break
            fi
            sleep 1
          done

          # URLãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
          if [ -z "$URL" ]; then
            echo "Failed to find Cloudflare URL. Dumping log:"
            cat /tmp/tunnel.log
            exit 1
          fi
          
          # URLã‚’ç’°å¢ƒå¤‰æ•°ã«ã‚‚ä¿å­˜ï¼ˆSummaryç”¨ï¼‰
          echo "URL=$URL" >> $GITHUB_ENV

      - name: Summary Info
        if: env.URL != ''
        run: |
          echo "### ðŸš€ Access Information" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ env.URL }}" >> $GITHUB_STEP_SUMMARY
          echo "**Password:** ${{ env.PASSWORD }}" >> $GITHUB_STEP_SUMMARY

      - name: Keep Alive
        run: |
          echo "Workflow is running. Click 'Cancel workflow' to stop."
          sleep 360m
