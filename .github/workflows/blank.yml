name: VS Code (Cloudflare Tunnel)

on:
  workflow_dispatch:
    inputs:
      keep_alive_minutes:
        description: 'è‡ªå‹•çµ‚äº†ã¾ã§ã®æ™‚é–“ï¼ˆåˆ†ã€æœ€å¤§360ï¼‰'
        required: true
        default: '360'
        type: string

jobs:
  setup-vscode:
    runs-on: ubuntu-latest
    
    # GitHub Actionsã®æœ€å¤§æ™‚é–“ã¯360åˆ†
    timeout-minutes: 360
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Random Password
        id: generate_pass
        run: |
          # ãƒ©ãƒ³ãƒ€ãƒ ãª32æ–‡å­—ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
          PASSWORD=$(openssl rand -base64 24)
          
          # GitHub Secretsã®ãƒã‚¹ã‚­ãƒ³ã‚°æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã€ä»¥é™ã®ãƒ­ã‚°ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè¦‹ãˆãªã„ã‚ˆã†ã«ã™ã‚‹
          echo "::add-mask::$PASSWORD"
          
          # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å‡ºåŠ›å¤‰æ•°ã«ã‚»ãƒƒãƒˆ
          echo "password=$PASSWORD" >> $GITHUB_OUTPUT
          
          echo "Generated Password successfully."

      - name: Install VS Code (code-server)
        run: |
          docker run -d \
            --name code-server \
            -p 127.0.0.1:8080:8080 \
            -v "${PWD}:/home/coder/project" \
            -e PASSWORD="${{ steps.generate_pass.outputs.password }}" \
            codercom/code-server:latest

      - name: Install Cloudflared
        run: |
          # Cloudflaredã®æœ€æ–°ç‰ˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          curl -L --output cloudflared https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          chmod +x cloudflared

      - name: Start Cloudflare Tunnel
        id: tunnel
        run: |
          echo "Starting Cloudflare Tunnel..."
          
          # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ãƒˆãƒ³ãƒãƒ«ã‚’å®Ÿè¡Œã—ã€ãƒ­ã‚°ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          ./cloudflared tunnel --url http://127.0.0.1:8080 --loglevel info > /tmp/tunnel.log 2>&1 &
          
          # URLãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿï¼ˆæœ€å¤§30ç§’ï¼‰
          for i in {1..30}; do
            if grep -q "https://" /tmp/tunnel.log; then
              break
            fi
            sleep 1
          done
          
          # ãƒ­ã‚°ã‹ã‚‰URLã‚’æŠ½å‡º
          URL=$(grep -m 1 "https://" /tmp/tunnel.log | awk '{print $NF}')
          
          # URLã‚’ç¢ºèª
          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            echo "Failed to retrieve Cloudflare Tunnel URL."
            cat /tmp/tunnel.log
            exit 1
          fi
          
          # å‡ºåŠ›å¤‰æ•°ã«ã‚»ãƒƒãƒˆ
          echo "access_url=$URL" >> $GITHUB_OUTPUT
          echo "Tunnel started successfully."

      - name: Output Access Info
        if: steps.tunnel.outputs.access_url != ''
        run: |
          echo "### ğŸš€ Access Your VS Code Environment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.tunnel.outputs.access_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Password:** ${{ steps.generate_pass.outputs.password }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â³ This workflow will automatically stop in ${{ inputs.keep_alive_minutes }} minutes (or click 'Cancel workflow')." >> $GITHUB_STEP_SUMMARY

      - name: Keep Alive
        run: |
          minutes=${{ inputs.keep_alive_minutes }}
          echo "Environment is ready! Keeping the workflow alive for $minutes minutes."
          echo "To stop immediately, cancel this workflow."
          
          # æŒ‡å®šã—ãŸåˆ†ã®é–“ã ã‘ã‚¹ãƒªãƒ¼ãƒ—ã—ç¶šã‘ã‚‹
          sleep ${{ inputs.keep_alive_minutes }}m
